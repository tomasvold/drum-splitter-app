<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Drum Stem Separator</title>
  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <img src="{{ url_for('static', filename='Logo.png') }}" alt="Drum Splitter Logo" class="logo">
    <p>Upload your stereo drum recording and create individual stems (kick, snare, toms, cymbals, hi-hat).</p>
    <p><small>Powered by <a href="https://music.ai" target="_blank" rel="noopener noreferrer">Music.AI</a> ‚Äî industry-leading AI for music processing.</small></p>
    <form id="uploadForm">
      <div class="file-input-wrapper">
          <input type="file" name="audio" id="audio_file" required>
      </div>
      <button type="submit">Upload and Split</button>
    </form> <div class="spinner" id="spinner"></div>
    <div class="message" id="messageArea">Please select a drum track to upload..</div>
  </div>

  <footer>
    <p>This tool uses <a href="https://music.ai/" target="_blank" rel="noopener noreferrer">Music.AI</a>, an industry-leading stem separation service. 
      Your Music.AI account will be charged approximately $0.15 per minute of audio processed.
    </p>
    <p>This website is created by Tom √Ösvold 2025, Los Angeles CA<br>
      <span class="social-links">
            <a href="https://www.instagram.com/tomasvold" target="_blank" rel="noopener noreferrer">Instagram</a> | 
            <a href="https://www.facebook.com/tomasvold" target="_blank" rel="noopener noreferrer">Facebook</a> | 
            <a href="https://www.linkedin.com/in/tomasvold" target="_blank" rel="noopener noreferrer">LinkedIn</a> |
            <a href="https://www.youtube.com/tomasvold" target="_blank" rel="noopener noreferrer">Youtube</a>
      </span>
    </p>
  </footer>
<script>
    const uploadForm = document.getElementById('uploadForm');
    const spinner = document.getElementById('spinner');
    const messageArea = document.getElementById('messageArea');
    
    let pollingInterval;

    function showMessage(text, type = 'info') {
        messageArea.innerText = text;
        messageArea.className = 'message';
        if (type === 'error') messageArea.classList.add('error-message');
        else if (type === 'success') messageArea.classList.add('success-message');
    }

    uploadForm.addEventListener('submit', async (event) => {
      event.preventDefault();

      spinner.style.display = 'block';
      showMessage('üöÄ Uploading file and creating job...', 'info');
      uploadForm.querySelector('button[type="submit"]').disabled = true;

      const formData = new FormData(uploadForm);

      try {
        const response = await fetch("{{ url_for('upload_file_and_create_job') }}", {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (!response.ok) throw new Error(data.error || `Server error: ${response.status}`);

        if (data.job_id) {
          showMessage(`‚è≥ Job created (ID: ${data.job_id}). Processing...`, 'info');
          pollJobStatus(data.job_id); // No API key passed here anymore
        }
      } catch (error) {
        showMessage(`Error: ${error.message}`, 'error');
        spinner.style.display = 'none';
        uploadForm.querySelector('button[type="submit"]').disabled = false;
      }
    });

    async function pollJobStatus(jobId) {
      if (pollingInterval) clearInterval(pollingInterval);

      pollingInterval = setInterval(async () => {
        try {
          // Clean URL: No more ?api_key= at the end
          const statusUrl = `{{ url_for('get_job_status', job_id='JOB_ID_PLACEHOLDER') }}`.replace('JOB_ID_PLACEHOLDER', jobId);
          
          const response = await fetch(statusUrl);
          const data = await response.json();

          if (!response.ok) throw new Error(data.error || 'Error checking status');
          
          if (data.status === 'SUCCEEDED') {
            clearInterval(pollingInterval);
            spinner.style.display = 'none';
            showMessage('üéâ Job completed! Redirecting...', 'success');
            // Clean Redirect: No more ?api_key= at the end
            window.location.href = `{{ url_for('show_results', job_id='JOB_ID_PLACEHOLDER') }}`.replace('JOB_ID_PLACEHOLDER', jobId);
          } else if (data.status === 'FAILED') {
            clearInterval(pollingInterval);
            spinner.style.display = 'none';
            uploadForm.querySelector('button[type="submit"]').disabled = false;
            showMessage(`‚ùå Job failed: ${data.error_details || 'Unknown error'}`, 'error');
          } else {
            showMessage(`‚è≥ Status: ${data.status}`, 'info');
          }
        } catch (error) {
          clearInterval(pollingInterval);
          spinner.style.display = 'none';
        }
      }, 5000);
    }
  </script>
  
</body>
</html>
